/*****************************************************************************
* Pusher event subscription functionality.
* Currently using ERB to access application config, to simplify demo.
* @see vendor/assets/javascripts/pusher.min.js
* @todo Implement `Global` for better access to application config
*       https://github.com/railsware/global
******************************************************************************/

/**
 * Creates a connection to the application's Pusher account, and subscribes to 
 *  the configured channel.  
 */
var subscribeToOrders = function(dataDisplayCallback) {
  var pusher  = new Pusher('<%= Rails.configuration.x.pusher.appkey.to_s %>');
  var channel = pusher.subscribe('<%= Rails.configuration.x.pusher.channel.to_s %>');

  channel.bind('order_recieved', function(data) {
    if (typeof dataDisplayCallback === 'function') {
      data = processPusherData(data);
      dataDisplayCallback(data);
    }
  });

  // may need to unsubscribe / disconnect on navigation away from page
}

/**
 * Parses the Pusher 'message' (data.order) as JSON
 * @param data Object
 *  Expects property data.order, as string containing Order data.
 */
var processPusherData = function(pusherData) {
  pusherData.order = JSON.parse(pusherData.order);
  return pusherData;
}